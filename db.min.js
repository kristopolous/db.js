(function(){function E(a){var d={};l(a,function(a){d[a]=!0});return d}function F(a,d){var b=arguments.length,c=1==b?a:d,f,e={};i.isArr(c)?(b=c.length,f=function(a){for(var e=0;e<b;e++)if(-1<p(a,c[e]))return!0;return!1}):f=function(a){return-1<p(a,c)};return 2==b?(e={},e[a]=f,e):f}function G(a){return a.length?n.call(a):r(a)}function s(){var a=n.call(arguments),d,b,c,f,e,g,h,k=G(i.isArr(this)?this:a.shift());2==a.length&&i.isStr(a[0])&&(c={},c[a[0]]=a[1],a=[o({},c)]);for(b=0;b<a.length;b++)if(d=a[b],
i.isFun(d)){d=d.single||d;for(e=k.length,h=e-1;0<=h;h--)c=k[h],d(c)&&(e-(h+1)&&(g=h+1,k.splice(g,e-g)),e=h);g=h+1;e-g&&k.splice(g,e-g)}else l(d,function(a,b){if(i.isFun(b))for(e=k.length,h=e-1;0<=h;h--)c=k[h],a in c&&(f=c[a],i.isFun(f)&&(f=f()),b(f,c)&&(e-(h+1)&&(g=h+1,k.splice(g,e-g)),e=h));else for(e=k.length,h=e-1;0<=h;h--)c=k[h],f=c[a],i.isFun(f)&&(f=f()),a in c&&f===b&&(e-(h+1)&&(g=h+1,k.splice(g,e-g)),e=h);g=h+1;e-g&&k.splice(g,e-g)});return k}function v(){var a=E(n.call(arguments));return function(d){for(var b in a)if(b in
d)return!1;return!0}}function w(a,d){var b,c=arguments.length,f,e={};1==c?f=a:2==c&&(f=d);f=f.toString().toLowerCase();b=function(a){return-1<a.toString().toLowerCase().search(f)};return 2==c?(e={},e[a]=b,e):b}function x(a){var d={x:a};return function(a,c){2==arguments.length&&(d[a]=c);return d[a]}}function r(a){var d=[],b;for(b in a)d.push(a[b]);return d}function H(a,d){var b,c=this;d!==y&&(b=a,a={},a[b]=d);i.isFun(a)?l(c,a):l(a,function(a,b){i.isFun(b)?l(c,function(c){if(i.isFun(c[a]))c[a](b(c));
else c[a]=b(c)}):l(c,function(c){if(i.isFun(c[a]))c[a](b);else c[a]=b})});return this}function o(a,d){for(var b,c,f,e,g=arguments.length,h=0;h<g;h++){b=arguments[h];for(var k in b)c=a[k],f=b[k],a!==f&&(f&&(f.constructor==Object||(e=i.isArr(f)))?(e?(e=!1,c=c&&i.isArr(constructor)?c:[]):c=c&&c.constructor==Object?c:{},a[k]=o(c,f)):f!==y&&(a[k]=f))}return a}function t(a,d){var b=[],c;2==arguments.length?(c=a,a=d):c=this;if(i.isArr(c))b=z(c,a);else{var b={},f;for(f in c)i.isFun(c[f])||(b[f]=a.call(this,
c[f]))}return b}function A(a){q++;for(var d=0,b=a.length;d<b;d++)a[d].constructor("i",q)}var y,n=Array.prototype.slice,u=Object.prototype.toString,B={},C={},q=0,i={isFun:function(a){return!(!a||!a.constructor||!a.call||!a.apply)},isStr:function(a){return!!(""===a||a&&a.charCodeAt&&a.substr)},isNum:function(a){return"[object Number]"===u.call(a)},isArr:[].isArray||function(a){return"[object Array]"===u.call(a)},isObj:function(a){return null==a?"object"==""+a:"[object Object]"===u.call(a)||!0}},p=[].indexOf?
function(a,d){return a.indexOf(d)}:function(a,d){for(var b=a.length-1;-1!=b&&d!=a[b];b--);return b},z=[].map?function(a,d){return a.map(d)}:function(a,d){for(var b=[],c=0,f=obj.length;c<f;c++)b.push(d(obj[c],c));return b},l=[].forEach?function(a,d){if(i.isArr(a))a.forEach(d);else for(var b in a)d(b,a[b])}:function(a,d){if(i.isArr(a))for(var b=0,c=a.length;b<c;b++)d(a[b],b);else for(b in a)d(b,a[b])};l("< <= > >= == === != !==".split(" "),function(a){C[a]=Function("rhs","return function(x){return x"+
a+"rhs}")});var D=function(){var a={};return function(d,b){var c,f=arguments.length,e=1==f?d:b||[],g={};if(!i.isArr(e))throw new TypeError("isin's argument is wrong. ",e);e.length?20>e.length&&i.isNum(e[0])?(c=e.join(","),c=a[c]?a[c]:a[c]=new Function("x","return x=="+e.join("||x=="))):c=function(a){return-1<p(e,a)}:c=i.isFun(e)?function(a){return-1<p(e(),a)}:e;return 2==f?(g={},g[d]=c,g):c}}(),I=function(){var a=/^\s*([=<>!]+)['"]*(.*)$/,d,b={};return function(){return function(c,f){var e,g;if(i.isStr(c)){g=
c;if(1==arguments.length)if(b[g])e=b[g];else{try{e=new Function("x,rec","return x "+g)}catch(h){e={}}try{e.single=new Function("rec","return "+c)}catch(k){}b[g]=e}2==arguments.length&&i.isStr(f)&&(e={},g=f,b[g]||(b[g]=null!==(d=g.match(a))?C[d[1]](d[2].replace(/['"]$/,"")):new Function("x,rec","return x "+g)),e[c]=b[g]);return e}}}}(),J=function(a){var d={};l(a,function(a){d[a]=!0});return d}("has hasKey insert invert missing isin group keyBy remove update where select find sort orderBy order each like".split(" "));
self.DB=function(a,d){function b(){h||(h=!0,l(g,function(a){a.call(j,m)}),h=!1)}function c(a){for(var c in J)a[c]=j[c];return a}function f(a){for(var c=[],b=0,e=a.length;b<e;b++)c[b]=m[a[b]];return c}var e={},g=[],h=!1,k=!1,j=I(),m=[];o(j,{constrain:function(){var a=o,c=e,b;var d=arguments,f={};2==d.length?(f[d[0]]=d[1],b=f):1==d.length&&(b=d[0]);a(c,b)},each:t,findFirst:function(){var a=j.find.apply(this,n.call(arguments));return a.length?a[0]:{}},has:F,hasKey:function(){return j.find(v.apply(this,
n.call(arguments))).invert()},isin:D,like:w,invert:function(a){var b=m,d=[];A(a||this);for(var a=0,e=b.length;a<e;a++)b[a].constructor("i")!=q&&d.push(b[a]);return c(d)},map:t,missing:function(){return j.find(v.apply(this,n.call(arguments)))},sync:function(a){a?g.push(a):b()},template:{create:function(a){k=a},update:function(a){o(k||{},a)},get:function(){return k},destroy:function(){k=!1}},update:function(){var a=H.apply(i.isArr(this)?this:j.find(),n.call(arguments));b();return c(a)}});j.group=function(a){var b=
{},d=i.isArr(this)?this:j.find();l(d,function(d){a in d&&(b[d[a]]||(b[d[a]]=c([])),b[d[a]].push(d))});return b};j.keyBy=function(a){var b=j.group.apply(this,arguments);l(b,function(a,c){b[a]=c[0]});return b};j.order=j.sort=j.orderBy=function(a,b){var d,e=arguments.length,f,g=i.isArr(this)?this:j.find();i.isFun(a)?d=a:i.isStr(a)&&(1==e?f="x-y":2==e&&(f=i.isStr(b)?{asc:"x-y",desc:"y-x"}[b.toLowerCase()]:b),i.isStr(f)&&!B[f]&&(B[f]=new Function("x,y","return "+f)),eval("fnSort=function(a,b){return order(a."+
a+", b."+a+")}"));return c(n.call(g).sort(d))};j.where=j.find=function(){var a=n.call(arguments||[]);i.isArr(this)||(a=[m].concat(a));return c(s.apply(this,a))};j.view=function(a){var c={};j.sync(function(b){var d={},e;l(b,function(b){a in b&&(d[b[a]]=b)});for(e in d)e in c?c[e]!==d[e]&&(c[e]=d[e]):c[e]=d[e];for(e in c)e in d||delete c[e]});b();return c};j.select=function(a){var b=i.isArr(this)?this:j.find(),d,e={};1<arguments.length?a=n.call(arguments):i.isStr(a)&&(a=[a]);d=a.length;l(a,function(a,
c){if("*"==a)e=z(b,r);else for(var f=0,g=b.length;f<g;f++)row=b[f],a in row&&(1<d?(e[f]||(e[f]=[]),e[f][c]=row[a]):e[f]=row[a])});return c(r(e))};j.insert=function(a){var d={},g=[],h=[];1<arguments.length?g=n.call(arguments):i.isArr(a)?g=a:g.push(a);l(g,function(a){if(e.unique&&(d={},l(m,function(a,b){d[a[e.unique]]=b}),a[e.unique]in d)){h.push(d[a[e.unique]]);return}var b=m.length,c;if(k){var f={};l(k,function(a,b){f[a]=i.isFun(b)?b():b});a=o(f,a)}try{c=new (x(b)),o(c,a),m.push(c)}catch(g){a.constructor=
x(b),m.push(a)}h.push(b)});b();return c(f(h))};j.remove=function(a,d){var e,f,g=[];e=i.isArr(this)?this:i.isArr(a)?a:0<arguments.length?j.find.apply(this,n.call(arguments)):j.find();A(e);var h=m.length-1;for(e=m.length;0<=h;h--)m[h].constructor("i")==q?g.push(m[h]):(e-(h+1)&&(f=h+1,m.splice(f,e-f)),e=h);f=h+1;e-f&&m.splice(f,e-f);b();return c(g.reverse())};if(1==arguments.length)if(i.isArr(a))j.insert(a);else if(i.isFun(a))j.insert(a());else{if(i.isStr(a))return j.apply(this,arguments);i.isObj(a)&&
j.insert(a)}else 1<arguments.length&&j.insert(n.call(arguments));j.__raw__=m;return j};o(DB,{find:s,each:t,like:w,isin:D,findFirst:function(){var a=s.apply(this,n.call(arguments));return a.length?a[0]:{}},reduceLeft:function(a,d){var b=i.isStr(d)?new Function("y,x","return y "+d):d;return function(c){for(var d=a,e=0,g=c.length;e<g;e++)c[e]&&(d=b(d,c[e]));return d}},reduceRight:function(a,d){d=DB.reduceLeft(a,d);return function(a){return d(a.reverse())}}})})();
