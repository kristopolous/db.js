!function(){function escapeRegExp(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function extend(a){return each(slice.call(arguments,1),function(b){if(b)for(var c in b)a[c]=b[c]}),a}function kvarg(a){var b={};return 2==a.length?(b[a[0]]=a[1],b):1==a.length?a[0]:void 0}function hash(a){var b={};return each(a,function(a){b[a]=!0}),b}function trace(a,b){a.__trace__={},each(a,function(c,d){_.isFun(d)&&(a.__trace__[c]=d,a[c]=function(){return console.log([c+":"].concat(slice.call(arguments))),b&&b.apply(this,arguments),a.__trace__[c].apply(this,arguments)})})}function copy(a){return"length"in a?slice.call(a):values(a)}function setdiff(a,b){var c=[];stain(b);for(var d=0,e=a.length;e>d;d++)isStained(a[d])||c.push(a[d]);return c}function stain(a){_stainID++;for(var b=0,c=a.length;c>b;b++)a[b].constructor("i",_stainID)}function isStained(a){return a.constructor("i")==_stainID}function has(a,b){var e,c=arguments.length,d=1==c?a:b,f={};if(_.isArr(d)){var c=d.length;e=function(a){for(var b=0;c>b;b++)if(indexOf(a,d[b])>-1)return!0;return!1}}else e=function(a){return indexOf(a,d)>-1};return 2==c?(f={},f[a]=e,f):e}function find(){var b,c,d,e,f,g,h,a=slice.call(arguments),i=copy(_.isArr(this)?this:a.shift());for(2==a.length&&_.isStr(a[0])&&(d={},d[a[0]]=a[1],a=[d]),c=0;c<a.length;c++)if(b=a[c],_.isArr(b)){var j=[],k=i;if(0===b.length)i=k;else{if(!_.isObj(b[0])&&2==a.length){var l=a.pop();b=map(b,function(a){return obj(a,l)})}for(h=0;h<b.length;h++)j=j.concat(find(k,b[h])),k=setdiff(k,j);i=j}}else if(_.isFun(b)){var m=b;for(f=i.length,h=f-1;h>=0;h--)d=i[h],m(d)&&(f-(h+1)&&(g=h+1,i.splice(g,f-g)),f=h);g=h+1,f-g&&i.splice(g,f-g)}else each(b,function(a,b){if(_.isObj(b)){var c=keys(b)[0],j=c.slice(1);if(!(j in DB))throw new Error(j+" is an unknown function");b=DB[j](b[c])}else _.isArr(b)&&(b=isin(b));if(_.isFun(b)){for(f=i.length,h=f-1;h>=0;h--)if(d=i[h],a in d){if(e=d[a],_.isFun(e)&&(e=e()),!b(e,d))continue;f-(h+1)&&(g=h+1,i.splice(g,f-g)),f=h}}else for(f=i.length,h=f-1;h>=0;h--)d=i[h],e=d[a],_.isFun(e)&&(e=e()),a in d&&e===b&&(f-(h+1)&&(g=h+1,i.splice(g,f-g)),f=h);g=h+1,f-g&&i.splice(g,f-g)});return i}function missing(a){var b=hash(a);return function(a){for(var c in b)if(c in a)return!1;return!0}}function isArray(a){var b=a.sort().join("");return function(a){return a.sort().join("")===b}}function like(a,b){var c,e,f,d=arguments.length,g={};return 1==d?e=a:2==d&&(e=b),e=e.toString(),c=function(a){if(null===a)return!1;try{f=new RegExp(e,"img")}catch(b){f=new RegExp(escapeRegExp(e),"img")}return a.toString().search(f)>-1},2==d?(g={},g[a]=c,g):c}function secret(a){var b={x:a};return function(a,c){return 2==arguments.length&&(b[a]=c),b[a]}}function update(a,b){var c,d=this;return b!==_u&&(c=a,a={},a[c]=b),_.isFun(a)?each(d,a):each(a,function(a,b){_.isFun(b)?each(d,function(c){_.isFun(c[a])?c[a](b(c)):c[a]=b(c)}):each(d,function(c){_.isFun(c[a])?c[a](b):c[a]=b})}),this}function not(a){return function(){return!a.apply(this,arguments)}}function eachRun(a,b){var e,c=0,d=[];if(2==arguments.length?(e=a,a=b):e=this,_.isArr(e))d=mapSoft(e,a);else{d={},_.isArr(a)&&(c=a[0],a=a[1]);for(var f in e)_.isFun(e[f])||(d[f]=a.call(c,e[f]))}return d}var _u,slice=Array.prototype.slice,toString=Object.prototype.toString,_orderCache={},_compProto={},_stainID=0,_={isFun:function(a){return!!(a&&a.constructor&&a.call&&a.apply)},isStr:function(a){return!!(""===a||a&&a.charCodeAt&&a.substr)},isNum:function(a){return"[object Number]"===toString.call(a)},isArr:[].isArray||function(a){return"[object Array]"===toString.call(a)},isBool:function(a){return a===!0||a===!1||"[object Boolean]"==toString.call(a)},isObj:function(a){return _.isFun(a)||_.isStr(a)||_.isNum(a)||_.isArr(a)?!1:null==a?"object"==String(a):"[object Object]"===toString.call(a)||!0}},indexOf=[].indexOf?function(a,b){return a.indexOf(b)}:function(a,b){for(var c=a.length-1;-1!=c&&b!=a[c];c--);return c},keys={}.keys||function(a){var b=[];for(var c in a)b.push(c);return b},values=function(a){var b=[];for(var c in a)b.push(a[c]);return b},obj=function(a,b){var c={};return c[a]=b,c},mapSoft=function(a,b){for(var c=[],d=0,e=a.length;e>d;d++)c.push(b(a[d],d));return c},map=[].map?function(a,b){return a.map(b)}:mapSoft,each=[].forEach?function(a,b){if(0!==a.length)if(_.isArr(a))a.forEach(b);else if(_.isStr(a)||_.isNum(a)||_.isBool(a))b(a);else for(var c in a)b(c,a[c])}:function(a,b){if(0!==a.length)if(_.isArr(a))for(var c=0,d=a.length;d>c;c++)b(a[c],c);else for(var e in a)b(e,a[e])};each("< <= > >= == === != !==".split(" "),function(a){_compProto[a]=Function("rhs","return function(x){return x"+a+"rhs}")});var isin=function(){return function(a,b){var c,d=arguments.length,e=1==d?a:b||[],f=[],g=[],h={};if(!_.isArr(e))throw new TypeError("isin's argument is wrong. ",e);return e.length?(each(e,function(a){_.isFun(a)?f.push(a):g.push(a)}),c=function(a){for(var b=indexOf(g,a)>-1,c=0;c<f.length&&!b;c++)b=f[c](a);return b}):c=_.isFun(e)?function(a){return indexOf(e(),a)>-1}:e,2==d?(h={},h[a]=c,h):c}}(),expression=function(){var b,a=/^\s*([=<>!]+)['"]*(.*)$/,c={};return function(){return function(d,e){var f,g;if(_.isStr(d)){if(g=d,1==arguments.length)if(c[g])f=c[g];else{try{f=new Function("x,rec","try { return x "+g+"} catch(e) {}")}catch(h){f=!1}if(!f)try{f=new Function("rec","try { return "+d+"} catch(e) {}")}catch(h){}c[g]=f}return 2==arguments.length&&_.isStr(e)&&(f={},g=e,c[g]||(c[g]=null!==(b=g.match(a))?_compProto[b[1]](b[2].replace(/['"]$/,"")):new Function("x,rec","try { return x "+g+"} catch(e) {}")),f[d]=c[g]),f}}}}(),chainList=hash(["each","find","findFirst","group","has","hasKey","indexBy","insert","invert","isin","keyBy","lazyView","like","missing","order","orderBy","remove","schema","select","slice","sort","unset","update","view","where"]);self.DB=function(arg0,arg1){function sync(){syncLock||(syncLock=!0,each(syncList,function(a){a.call(ret,raw)}),syncLock=!1)}function chain(a){for(var b in chainList)a[b]=ret[b];return a.first=a[0],a.last=a[a.length-1],a}function list2data(a){for(var b=[],c=0,d=a.length;d>c;c++)b[c]=raw[a[c]];return b}var constraints={addIf:[]},constrainCache={},syncList=[],syncLock=!1,_ix={ins:0,del:0},_template=!1,ret=expression(),_g={},raw=[];if(extend(ret,{slice:function(){var a=_.isArr(this)?this:ret.find();return chain(slice.apply(a,arguments))},transaction:{start:function(){syncLock=!0},end:function(){syncLock=!1,sync()}},schema:function(){for(var e,a={},b=_.isArr(this)?this:ret.find(),c=b.length,d=Math.ceil(Math.min(10,c/3)),f=0;c>f;f+=d){e=b[f];for(var g in e)a[g]=_u}return keys(a)},constrain:function(){extend(constraints,kvarg(arguments))},addIf:function(a){return a&&constraints.addIf.push(a),constraints.addIf},beforeAdd:function(a){return ret.addIf(a?function(){return a.apply(0,arguments),!0}:!1)},unset:function(a){if(_.isArr(a))return each(a,arguments.callee);var b=_.isArr(this)?this:ret.find();return each(b,function(b){a in b&&delete b[a]}),sync(),chain(b)},each:eachRun,not:not,findFirst:function(){var a=ret.find.apply(this,arguments);return a.length?a[0]:!1},has:has,hasKey:function(){var a=_.isArr(this)?this:this.find(),b=a.find(missing(slice.call(arguments)));return this.invert(b,a)},isin:isin,like:like,invert:function(a,b){return chain(setdiff(b||raw,a||this))},map:eachRun,missing:function(){var a=missing(slice.call(arguments));return _.isArr(this)?this.find(a):a},sync:function(a){return a?syncList.push(a):sync(),ret},template:{create:function(a){_template=a},update:function(a){extend(_template||{},a)},get:function(){return _template},destroy:function(){_template=!1}},update:function(){var a=update.apply(_.isArr(this)?this:ret.find(),arguments);return sync(),chain(a)}}),ret.group=function(a){var b={},c=_.isArr(this)?this:ret.find();return each(c,function(c){a in c&&each(c[a],function(a){a in b||(b[a]=chain([])),b[a].push(c)})}),b},ret.keyBy=function(){var b=ret.group.apply(this,arguments);return each(b,function(a,c){b[a]=c[0]}),b},ret.indexBy=function(){var a=chain;chain=function(a){return a},ret.__raw__=raw=ret.order.apply(this,arguments),chain=a},ret.order=ret.sort=ret.orderBy=function(arg0,arg1){var key,fnSort,len=arguments.length,order,filter=_.isArr(this)?this:ret.find();return _.isFun(arg0)?fnSort=arg0:_.isStr(arg0)&&(key=arg0,1==len?order="x-y":2==len&&(order=_.isStr(arg1)?{asc:"x-y",desc:"y-x"}[arg1.toLowerCase()]:arg1),_.isStr(order)&&(order=_orderCache[order]?_orderCache[order]:_orderCache[order]=new Function("x,y","return "+order)),eval("fnSort=function(a,b){return order(a."+key+", b."+key+")}")),chain(slice.call(filter).sort(fnSort))},ret.where=ret.find=function(){var a=slice.call(arguments||[]);return _.isArr(this)||(a=[raw].concat(a)),chain(find.apply(this,a))},ret.lazyView=function(field,type){function update(a){if(a){if("del"==a&&myix.del==_ix.del)return;if("ins"==a&&myix.ins==_ix.ins)return}myix={del:_ix.del,ins:_ix.ins};var b={};each(raw,function(a){keyer(a,b)});for(var c in update)c in b||delete update[c]}var myix={del:_ix.del,ins:_ix.ins},keyer;return("["!==field.charAt(0)||"."!==field.charAt(0))&&(field="."+field),eval("keyer = function(r,ref){try{ref[rX] = update[rX] = r;} catch(x){}}".replace(/X/g,field)),update(),update},ret.view=function(a,b){var c=ret.lazyView(a,b);return ret.sync(c),c},ret.select=function(a){var c,b=_.isArr(this)?this:ret.find(),d={};return arguments.length>1?a=slice.call(arguments):_.isStr(a)&&(a=[a]),c=a.length,each(a,function(a,e){if("*"==a)d=map(b,values);else for(var f=0,g=b.length;g>f;f++)row=b[f],a in row&&(c>1?(d[f]||(d[f]=[]),d[f][e]=row[a]):d[f]=row[a])}),chain(values(d))},ret.insert=function(a){var b,c=constraints.unique,d=[],e=[],f=[];return e=arguments.length>1?slice.call(arguments):_.isArr(a)?a:[a],each(e,function(a){var g,e=!0;if(c&&c in a){var i,h="c-"+c;_g[h]?_g[h]("del"):_g[h]=ret.lazyView(c),i=_g[h],a[c]in i?(d.push(i[a[c]]),f.push(i[a[c]]),e=!1):i[a[c]]=a}if(each(constraints.addIf,function(b){e&=b(a)}),e){if(_ix.ins++,b=raw.length,_template){var j={};each(_template,function(a,b){j[a]=_.isFun(b)?b():b}),a=extend(j,a)}try{g=new(secret(b)),extend(g,a),a=g}catch(k){a.constructor=secret(b)}raw.push(a),f.push(b)}}),sync(),extend(chain(list2data(f)),{existing:d})},ret.remove=function(a){var d,e,f,c=!1,g=[];f=_.isArr(this)?this:_.isArr(a)?a:arguments.length>0?ret.find.apply(this,arguments):ret.find(),stain(f);for(var h=raw.length-1,d=raw.length;h>=0;h--)isStained(raw[h])?g.push(raw[h]):(d-(h+1)&&(e=h+1,raw.splice(e,d-e),c=!0),d=h);return e=h+1,d-e&&(raw.splice(e,d-e),c=!0),c&&(_ix.del++,sync()),chain(g.reverse())},1==arguments.length)if(_.isArr(arg0))ret.insert(arg0);else if(_.isFun(arg0))ret.insert(arg0());else{if(_.isStr(arg0))return ret.apply(this,arguments);_.isObj(arg0)&&ret.insert(arg0)}else arguments.length>1&&ret.insert(slice.call(arguments));return ret.__raw__=raw,DB.all.push(ret),ret},extend(DB,{all:[],find:find,diff:setdiff,each:eachRun,not:not,like:like,trace:trace,values:values,isin:isin,isArray:isArray,local:function(){return"(function(){ return "+DB.apply(this,arguments).toString()+";})()"},copy:function(a){return map(a,function(a){return extend({},a)})},objectify:function(a,b){var c=[];return each(b,function(b){var d={};each(a,function(a,c){d[a]=b[c]}),c.push(d)}),c},findFirst:function(){var a=find.apply(this,arguments);return a.length?a[0]:{}},reduceLeft:function(a,b){var c=_.isStr(b)?new Function("y,x","return y "+b):b;return function(b){for(var d=a,e=0,f=b.length;f>e;e++)b[e]&&(d=c(d,b[e]));return d}},reduceRight:function(a,b){var b=DB.reduceLeft(a,b);return function(a){return b(a.reverse())}}})}();