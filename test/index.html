<!doctype html>
<html>
<head>
  <title>db.js test suite</title>
  <link rel=stylesheet href=qunit.css>
  <script src="jquery.js"></script>
  <script src=../db.min.js > </script>
  <script src=qunit.js > </script>
</head>
<body>
  <h1 id=qunit-header>db.js test suite</h1>
  <h2 id="qunit-banner"></h2>
  <div id="qunit-testrunner-toolbar"></div>
  <h2 id="qunit-userAgent"></h2>
  <ol id="qunit-tests"></ol>
  <div id="qunit-fixture">test markup, will be hidden</div>
</body>
<script>
$(function(){
module("Initialization");

  test("No arguments", function(){
    var db = DB();
    equal(db.__raw__.length, 0, "The database has one element");
  });

  test("One KV arg", function(){
    var db = DB({key: 'value'});
    equal(db.__raw__.length, 1, "The database has one element");
    equal(db.__raw__[0].key, "value", "The first element has a key and a value");
  });

  test("Multiple KV arg", function(){
    var db = DB(
      { key1: 0 }, 
      { key2: 'value2' }, 
      { key1: 'value3' }
    );

    equal(db.__raw__.length, 3, "Three items were inserted");
    equal(db.__raw__[0].key1, 0, "The first has an integer value 0");
    equal(db.__raw__[1].key2, "value2", "The second has a string value 'value2'");
    equal(db.__raw__[2].key1, "value3", "the third has a string value 'value3'");
  });

  test("Multiple KV arg as array", function(){
    var db = DB(
      { key1: 0 }, 
      { key2: 'value2' }, 
      { key1: 'value3' }
    );

    equal(db.__raw__.length, 3, "Three items were inserted");
    equal(db.__raw__[0].key1, 0, "The first has an integer value 0");
    equal(db.__raw__[1].key2, "value2", "The second has a string value 'value2'");
    equal(db.__raw__[2].key1, "value3", "the third has a string value 'value3'");
  });

module("Insertion");
  test("One KV arg", function(){
    var db = DB();
    db.insert({key: 'value'});
    equal(db.__raw__.length, 1, "The database has one element");
    equal(db.__raw__[0].key, "value", "The first element has a key and a value");
  });

  test("Multiple KV arg", function(){
    var db = DB();
    db.insert(
      { key1: 0 }, 
      { key2: 'value2' }, 
      { key1: 'value3' }
    );

    equal(db.__raw__.length, 3, "Three items were inserted");
    equal(db.__raw__[0].key1, 0, "The first has an integer value 0");
    equal(db.__raw__[1].key2, "value2", "The second has a string value 'value2'");
    equal(db.__raw__[2].key1, "value3", "the third has a string value 'value3'");
  });

  test("Multiple KV arg as array", function(){
    var db = DB();
    db.insert([{key1: 0}, {key2: 'value2'}, {key1: 'value3'}]);
    equal(db.__raw__.length, 3, "Three items were inserted");
    equal(db.__raw__[0].key1, 0, "The first has an integer value 0");
    equal(db.__raw__[1].key2, "value2", "The second has a string value 'value2'");
    equal(db.__raw__[2].key1, "value3", "the third has a string value 'value3'");
  });

  test("Multiple KV arg as chain", function(){
    var db = DB();
    db
      .insert({key1: 0})
      .insert({key2: 'value2'})
      .insert({key1: 'value3'});

    equal(db.__raw__.length, 3, "Three items were inserted");
    equal(db.__raw__[0].key1, 0, "The first has an integer value 0");
    equal(db.__raw__[1].key2, "value2", "The second has a string value 'value2'");
    equal(db.__raw__[2].key1, "value3", "the third has a string value 'value3'");
  });

  test("Data from the DOM", function(){
    expect(1);
    var db = DB();

    db.insert(document.getElementsByTagName('*'));
    equal(true, true, "Got past");
  });

  test("Data from the document object", function(){
    expect(1);
    var db = DB(
      DB.values(document)
    );

    equal(true, true, "Got past");
  });

module('copy');
  test("Trivial copy", function(){
    var 
      db = DB({a: 1}),
      db1 = DB(DB.copy(db.find()));

    db1.find()[0].a = 100;
    equal(db.find()[0].a, 1, "Copy modifies independent data");
    equal(db1.find()[0].a, 100, "Copy modifies independent data");

  });

  test("Multi index copy", function(){
    var 
      db = DB([{a: 1}, {a: 2}, {a: 3}]),
      db1 = DB(DB.copy(db.find()));

    db1.find()[1].a = 100;
    equal(db.find()[1].a, 2, "Copy modifies independent data");
    equal(db1.find()[1].a, 100, "Copy modifies independent data");

    db1.find()[0].a = 103;
    equal(db.find()[0].a, 1, "Copy modifies independent data");
    equal(db1.find()[0].a, 103, "Copy modifies independent data");

  });
module('transaction');
  test("Start a transaction, do 10 operations, end it", function(){
    expect(1);
    var 
      db = DB(),
      counter = 0;

    db.sync(function(){
      equal(counter, 0, "First time here");
      counter++;
    });

    db.transaction.start(); {
      for(var i = 0; i < 10;i ++) {
        db.insert({k: i});
      }
    } db.transaction.end(); 
 });

  test("Start a transaction, do 10 operations, end it, do 10 more", function(){
    expect(11);
    var db = DB();

    db.sync(function(){
      equal(true, true, "counting number of times run");
    });

    db.transaction.start(); {
      for(var i = 0; i < 10;i ++) {
        db.insert({k: i});
      }
    } db.transaction.end(); 

    for(var i = 0; i < 10;i ++) {
      db.insert({k: i});
    }
 });

module('constrain');
  test("Create a table, constrain by key - check return", function(){
    var db = DB();

    db.constrain('unique', 'key1');

    var val = db.insert( 
      { key1: 0, a:0 }, 
      { key2: 'value2', a:1 }, 
      { key1: 0, a:2 }
    );

    equal(db.__raw__.length, 2, "Two items were inserted");
    equal(db.__raw__[0].key1, 0, "The first has an integer value 0");
    equal(db.__raw__[1].key2, "value2", "The second has a string value 'value2'");
    /*
    equal(val.length, 3, "Three things were returned");
    console.log("vv", val);
    equal(val[2].a, 0, "The third thing has the first value");
    */
  });

  test("Create a table, constrain by key - remove", function(){
    var db = DB();

    db.constrain('unique', 'key1');

    var val = db.insert( 
      { key1: 0, a:0 }, 
      { key2: 'value2', a:1 }
    );

    window.db = db;
    // after this I should be able to
    // insert a new record.
    db.remove({key1: 0});

    db.insert({key1: 1, a: 2});

    equal(db.__raw__.length, 2, "Two items were inserted");
    equal(db.__raw__[1].key1, 1, "The first has an integer value 0");
    equal(db.__raw__[0].key2, "value2", "The second has a string value 'value2'");
  });

  test("Create a table, constrain by key - two step", function(){
    var db = DB();

    db.constrain('unique', 'key1');

    var val = db.insert( 
      { key1: 0, a:0 }, 
      { key2: 'value2', a:1 }
    );

    db.insert({key1: 0, a: 2});

    equal(db.__raw__.length, 2, "Two items were inserted");
    equal(db.__raw__[0].a, 0, "The first has an integer value 0");
    equal(db.__raw__[1].key2, "value2", "The second has a string value 'value2'");
  });

module('AddIf');
  test("Only add if the key == 2", function(){
    var db = DB();
    expect(6);

    db.addIf(function(what) {
      equal(true, true, "AddIf being run");
      return what.key == 2;
    });

    db.insert(
      { key: 1 },
      { key: 2 },
      { key: 3 }
    );

    equal(db.__raw__.length, 1, "There's only one item in the database");
    equal(db.__raw__[0].key, 2, "This item has the right value");
    equal(db.addIf().length, 1, "There is one constraint");
  });

  test("Only add if the key == 2 and value == 3; two functions", function(){
    var db = DB();
    expect(9);

    db.addIf(function(what) {
      equal(true, true, "AddIf being run");
      return what.key == 2;
    });

    db.addIf(function(what) {
      equal(true, true, "AddIf being run");
      return what.value == 3;
    });

    db.insert(
      { key: 1 , value: 2},
      { key: 2 , value: 3},
      { key: 2 , value: 2}
    );

    equal(db.__raw__.length, 1, "There's only one item in the database");
    equal(db.__raw__[0].key, 2, "This item has the right value");
    equal(db.addIf().length, 2, "There are two constraints");
  });

  test("Only add if the key == 2, add a value == 3 function, then remove it", function(){
    var db = DB();
    expect(7);

    db.addIf(function(what) {
      equal(true, true, "AddIf being run");
      return what.key == 2;
    });

    db.addIf(function(what) {
      equal(true, true, "AddIf being run");
      return what.value == 3;
    });

    equal(db.addIf().length, 2, "There are two constraints");
    db.addIf().pop();

    db.insert(
      { key: 1 , value: 2},
      { key: 2 , value: 2},
      { key: 2 , value: 3}
    );

    equal(db.__raw__.length, 2, "There's two items in the database");
    equal(db.__raw__[0].value, 2, "This item has the right value");
    equal(db.addIf().length, 1, "There is one constraint");
  });

module('beforeAdd');
  test("Run a test and increment a value before insertion", function(){
    var db = DB();

    db.beforeAdd(function(what) {
      equal(true, true, "beforeAdd being run");
      what.key ++;
      what.newkey = 1;
    });

    db.insert([
      { key: 1 },
      { key: 2 }
    ]);

    equal(db.__raw__.length, 2, "There's only one item in the database");
    equal(db.__raw__[0].key, 2, "This item has the right value");
    equal(db.__raw__[0].newkey, 1, "This item has the right value");
    equal(db.beforeAdd().length, 1, "There is one constraint");
  });

module("Removal");
  test("Remove all", function(){
    var db = DB(
      { key1: 0 }, 
      { key2: 'value2' }, 
      { key1: 'value3' }
    );

    var removedRecords = db.remove();
    equal(db.__raw__.length, 0, "All items have been removed");
    equal(removedRecords.length, 3, "I got three records back");
    equal(removedRecords[0].key1, 0, "The first record looks right");
    equal(typeof removedRecords.find, 'function', "It looks to be chained too");
  });

  test("Remove first element by KV", function(){
    var db = DB(
      { key1: 0 }, 
      { key2: 'value2' }, 
      { key1: 'value3' }
    );

    db.remove({key1: 0});
    equal(db.__raw__.length, 2, "There's two elements left");
    equal(db.__raw__[0].key2, "value2", "The first one has the expected value");
  });

  test("Remove first element by KV - find pattern", function(){
    var db = DB(
      { key1: 0 }, 
      { key2: 'value2' }, 
      { key1: 'value3' }
    );

    db.find({key1: 0}).remove();
    equal(db.__raw__.length, 2, "There's two elements left");
    equal(db.__raw__[0].key2, "value2", "The first one has the expected value");
  });

  test("Remove middle element by KV", function(){
    var db = DB(
      { key1: 0 }, 
      { key2: 'value2' }, 
      { key1: 'value3' }
    );

    db.remove({key2: 'value2'});
    equal(db.__raw__.length, 2, "There's two elements left");
    equal(db.__raw__[1].key1, "value3", "The last one has the expected value");
  });

  test("Remove last element by KV", function(){
    var db = DB(
      { key1: 0 }, 
      { key2: 'value2' }, 
      { key1: 'value3' }
    );

    db.remove({key1: 'value3'});
    equal(db.__raw__.length, 2, "There's two elements left");
  });

  test("(Remove last element by KV, insert again) * 10", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res,
      ix = 0;

    for(ix = 0; ix < 10; ix ++) {
      db.insert( db.remove({key1: 'value3'}) );
    }

    equal(db.__raw__.length, 3, "There's three elements");
  });

module("Removal - syntax check");
  test("Remove middle element by arglist", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.remove('key2', 'value2');

    equal(db.__raw__.length, 2, "There's two elements left");
    equal(db.__raw__[1].key1, "value3", "The last one has the expected value");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Remove middle element by record function", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.remove(function(record) { return record.key2 == 'value2'; });

    equal(db.__raw__.length, 2, "There's two elements left");
    equal(db.__raw__[1].key1, "value3", "The last one has the expected value");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Remove middle element by key function", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.remove({key2: function(value) { return value == 'value2'; }});

    equal(db.__raw__.length, 2, "There's two elements left");
    equal(db.__raw__[1].key1, "value3", "The last one has the expected value");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Remove middle element by expression", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.remove({key2: db('== "value2"')});

    equal(db.__raw__.length, 2, "There's two elements left");
    equal(db.__raw__[1].key1, "value3", "The last one has the expected value");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

module("unset");
  test("Unset a single key", function(){
    var 
      db = DB(
        { key1: 0, key2: 1 }, 
        { key2: 'value2', key3: false }, 
        { key1: 'value3', key2: null }
      );

    db.unset('key2');

    equal('key2' in db.__raw__[0], false, "key2 not in the first record");
    equal('key2' in db.__raw__[1], false, "key2 also not in the second record");
  });

  test("Unset a single key in a find chain", function(){
    var 
      db = DB(
        { key1: 0, key2: 1 }, 
        { key2: 'value2', key3: false }, 
        { key1: 'value3', key2: null }
      );

    db.find({key1: 0}).unset('key2');

    equal('key2' in db.__raw__[0], false, "key2 not in the first record");
    equal('key2' in db.__raw__[1], true, "key2 in the second record still");
  });

  test("Unset a list of keys", function(){
    var 
      db = DB(
        { key1: 0, key2: 1 }, 
        { key2: 'value2', key3: false }, 
        { key1: 'value3', key2: null }
      );

    db.unset(['key2', 'key1']);
    equal('key1' in db.__raw__[0], false, "key1 not in the first record");
    equal('key2' in db.__raw__[0], false, "key2 also not in first result");
    equal('key3' in db.__raw__[1], true, "key3 still in second result");
  });

module("update");
  test("Add a Key/Value pair by Object", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.update({key4: 0});

    equal(db.__raw__[0].key4, 0, "Checks out");
    equal(db.__raw__[1].key4, 0, "Checks out");
    equal(db.__raw__[2].key4, 0, "Checks out");
  });

  test("Add a Key/Value pair by argList", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.update('key4', 0);

    equal(db.__raw__[0].key4, 0, "Checks out");
    equal(db.__raw__[1].key4, 0, "Checks out");
    equal(db.__raw__[2].key4, 0, "Checks out");
  });

  test("Add a Key/Value pair by record Function", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.update(function(record){
        record.key4 = 0;
      });

    equal(db.__raw__[0].key4, 0, "Checks out");
    equal(db.__raw__[1].key4, 0, "Checks out");
    equal(db.__raw__[2].key4, 0, "Checks out");
  });

  test("Add a Key/Value pair by keyed Function with global variables", function(){
    self.i = 0;
    var 
      db = DB({}, {}, {}, {}),
      res = db.update({a: DB('i++')});

    equal(db.__raw__[0].a, 0, "Checks out");
    equal(db.__raw__[1].a, 1, "Checks out");
    equal(db.__raw__[2].a, 2, "Checks out");
    equal(db.__raw__[3].a, 3, "Checks out");

    self.i = 0xBADC0DE;
  });

  test("Add a Key/Value pair by keyed Function with local variables", function(){
    var 
      i = 0,
      db = DB({}, {}, {}, {}),
      res = db.update({a: eval(DB.local('i++'))});

    equal(db.__raw__[0].a, 0, "Checks out");
    equal(db.__raw__[1].a, 1, "Checks out");
    equal(db.__raw__[2].a, 2, "Checks out");
    equal(db.__raw__[3].a, 3, "Checks out");
  });

  test("Insert an element into an existing db, chain an update and make sure only that element is updated", function(){
    var db = DB({a: 1, b: 1});

    db.insert({a: 2}).update({b: 3});

    equal(db.__raw__[0].b, 1, "b value maintained");
    equal(db.__raw__[1].b, 3, "new b value assigned");

  });

module("Finding");
  test("Find all elements", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.find();

    equal(res.length, 3, "I got three records");
    equal(res[0].key1, 0, "They are the right ones");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find all elements cascaded, 3 times", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.find();

    res = res.find();
    res = res.find();

    equal(res.length, 3, "I got three records");
    equal(res[0].key1, 0, "They are the right ones");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find an empty set, then do a second find", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.find({something: 'invalid'});

    equal(res.length, 0, "I got zero records");

    res = res.find();
    equal(res.length, 0, "After a second find, I still have zero records");
  });

  test("Find one element by Object", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.find({key1: 0});

    equal(res.length, 1, "I got one record");
    equal(res[0].key1, 0, "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find one element by argList", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.find('key1', 0);

    equal(res.length, 1, "I got one record");
    equal(res[0].key1, 0, "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find one element by record function", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.find(function(record) {
        return record.key1 === 0;
      });

    equal(res.length, 1, "I got one record");
    equal(res[0].key1, 0, "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find one element by key function", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.find({key1: function(value) {
        return value === 0;
      }});

    equal(res.length, 1, "I got one record");
    equal(res[0].key1, 0, "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find one element by key expression", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.find({key1: db('=== 0')});

    equal(res.length, 1, "I got one record");
    equal(res[0].key1, 0, "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find one element by anonymous expression", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.find(db('key1', '=== 0'));

    equal(res.length, 1, "I got one record");
    equal(res[0].key1, 0, "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find one element by argList", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.find('key1', 0);

    equal(res.length, 1, "I got one record");
    equal(res[0].key1, 0, "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find one element by record function", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.find(function(record) {
        return record.key1 === 0;
      });

    equal(res.length, 1, "I got one record");
    equal(res[0].key1, 0, "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find one element by key function", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.find({key1: function(value) {
        return value === 0;
      }});

    equal(res.length, 1, "I got one record");
    equal(res[0].key1, 0, "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find one element by expression", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.find({key1: db('=== 0')});

    equal(res.length, 1, "I got one record");
    equal(res[0].key1, 0, "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find using the or operator - empty base case", function(){
    var 
      db = DB(
        {key: 1},
        {key: 2},
        {key: 3}
      ),
      res = db.find([]);

    equal(res.length, 3, "I got three record");
    equal(res[0].key, 1, "It is the right first");
    equal(res[2].key, 3, "It is the right last");
  });

  test("Find using the or operator", function(){
    var 
      db = DB(
        {key: 1},
        {key: 2},
        {key: 3}
      ),
      res = db.find([{key: 1}, {key: 3}]);

    equal(res.length, 2, "I got two record");
    equal(res[0].key, 1, "It is the right first");
    equal(res[1].key, 3, "It is the right last");
  });

  test("Find using the OR operator with an AND operation - base", function(){
    var 
      db = DB(
        {a: 1, b: 1},
        {a: 1, b: 2},
        {a: 1, b: 3},

        {a: 2, b: 1},
        {a: 2, b: 2},
        {a: 2, b: 3}
      ),
      res = db.find({a: 1}, []);

    equal(res.length, 3, "I got three record");
    equal(res[0].a, 1, "It is the right first");
    equal(res[0].b, 1, "It is the right first");
    equal(res[2].a, 1, "It is the right last");
    equal(res[2].b, 3, "It is the right last");
  });

  test("Find using the OR operator with an AND operation - two ORs", function(){
    var 
      db = DB(
        {a: 1, b: 1},
        {a: 1, b: 2},
        {a: 1, b: 3},

        {a: 2, b: 1},
        {a: 2, b: 2},
        {a: 2, b: 3}
      ),
      res = db.find(
        {a: 1}, 
        [{b: 1}, {b: 2}]
      );

    equal(res.length, 2, "I got two record");
    equal(res[0].a, 1, "It is the right first");
    equal(res[0].b, 1, "It is the right first");
    equal(res[1].a, 1, "It is the right last");
    equal(res[1].b, 2, "It is the right last");
  });

  test("Find using the OR operator with an AND operation - inverted", function(){
    var 
      db = DB(
        {a: 1, b: 1},
        {a: 1, b: 2},
        {a: 1, b: 3},

        {a: 2, b: 1},
        {a: 2, b: 2},
        {a: 2, b: 3}
      ),
      res = db.find(
        [{b: 1}, {b: 2}],
        {a: 1}
      );

    equal(res.length, 2, "I got two record");
    equal(res[0].a, 1, "It is the right first");
    equal(res[0].b, 1, "It is the right first");
    equal(res[1].a, 1, "It is the right last");
    equal(res[1].b, 2, "It is the right last");
  });

  test("Find using the or operator - duplicate conditions shouldn't yield duplicate results", function(){
    var 
      db = DB(
        {key: 1},
        {key: 2},
        {key: 3}
      ),
      res = db.find([{key: 1}, {key: 2}, {key: 1}, {key: 1}, {key: 2}]);

    equal(res.length, 2, "I got two record");
    equal(res[0].key, 1, "It is the right first");
    equal(res[1].key, 2, "It is the right last");
  });

  test("Find using the or operator - array in first arg + condition", function(){
    var 
      db = DB(
        { key1: 1, key2: 2 },
        { key1: 2, key2: 1 },
        { key1: 3, key2: 2 }
      ),
      res = db.find(['key1', 'key2'], 1);

    equal(res.length, 2, "I got two record");
    equal(res[0].key1, 1, "It is the right first");
    equal(res[1].key2, 1, "It is the right last");
  });

  test("Find using the or operator part2", function(){
    var 
      db = DB(),
      filter = [],
      res,
      ix;

    for(ix = 0; ix < 20; ix++) {
      db.insert({key: ix});
      if(ix % 2) {
        filter.push({key: ix});
      }
    }

    res = db.find(filter);

    equal(res.length, filter.length, "I got the expected number of record");
  });

  test("Find an array using isArray", function(){
    var 
      db = DB({key: [1,2,3]}),
      res;

    // this should return nothing.
    res = db.find({key: [1,2,3]});
    equal(res.length, 0, "I failed to find the array using the isin short syntax. Good!");

    res = db.find({key: DB.isArray([1,2,3])});
    equal(res.length, 1, "I succeeded to find the array using the isArray method");

    res = db.find({key: DB.isArray([1,2])});
    equal(res.length, 0, "I failed to find the array using the isArray method with a bad query");
  });

module("FindFirst");
  test("First element by Object", function(){
    expect(1);
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.findFirst({key1: 0});

    equal(res.key1, 0, "It is the right one");
  });

  test("First element by Object - pointer", function(){
    expect(1);
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.find({key1: 0});

    equal(res.first.key1, 0, "It is the right one");
  });

  test("First element by Object - pointer self-assign", function(){
    expect(1);
    var 
      res = 0;
      db = DB(
        { key1: 0 }, 
        { key2: 0 }, 
        { key1: 'value3' }
      );

    res = db.find({key1: res}).first;

    equal(res.key1, 0, "It is the right one");
  });

  test("First element by argList", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.findFirst('key1', 0);

    equal(res.key1, 0, "It is the right one");
  });

  test("First element by record function", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.findFirst(function(record) {
        return record.key1 === 0;
      });

    equal(res.key1, 0, "It is the right one");
  });

  test("First element by key function", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.findFirst({key1: function(value) {
        return value === 0;
      }});

    equal(res.key1, 0, "It is the right one");
  });

  test("First element by key expression", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.findFirst({key1: db('=== 0')});

    equal(res.key1, 0, "It is the right one");
  });

  test("First element by anonymous expression", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.findFirst(db('key1', '=== 0'));

    equal(res.key1, 0, "It is the right one");
  });

  test("First element by argList", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.findFirst('key1', 0);

    equal(res.key1, 0, "It is the right one");
  });

  test("First element by record function", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.findFirst(function(record) {
        return record.key1 === 0;
      });

    equal(res.key1, 0, "It is the right one");
  });

  test("First element by key function", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.findFirst({key1: function(value) {
        return value === 0;
      }});

    equal(res.key1, 0, "It is the right one");
  });

  test("First element by expression", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.findFirst({key1: db('=== 0')});

    equal(res.key1, 0, "It is the right one");
  });

  test("First element by Object - failure", function(){
    expect(1);
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.findFirst({key1: 123});

    equal(res, false, "Nothing found so false is returned");
  });

module("like");
  test("Find records based on KV convention", function(){
    var 
      db = DB(
        { key: 'abcde' }, 
        { key: 'cdefg' }, 
        { key: 'efgh' }, 
        { key: 'aceg' }
      ),
      res = db.find({key: db.like('cd')});

    equal(res.length, 2, "I got two records");
    equal(res[1].key, 'cdefg', "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find records based on KV convention - malformed regex", function(){
    var 
      db = DB(
        { key: 'ab[cde' }, 
        { key: 'cd]efg' }, 
        { key: 'efb[c]gh' }, 
        { key: 'aceg' }
      ),
      res = db.find({key: db.like('b[c')});

    equal(res.length, 2, "I got two records");
    equal(res[1].key, 'efb[c]gh', "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find records on a table with null values", function(){
    var 
      db = DB(
        { key: 'abcde' }, 
        { key:  null }, 
        { key:  null }, 
        { key: 'cdee' }
      ),
      res = db.find({key: db.like('cd')});

    equal(res.length, 2, "I got two records");
    equal(res[1].key, 'cdee', "It is the right one");
  });

  test("Find records based on argList convention", function(){
    var 
      db = DB(
        { key: 'abcde' }, 
        { key: 'cdefg' }, 
        { key: 'efgh' }, 
        { key: 'aceg' }
      ),
      res = db.find(db.like('key', 'cd'));

    equal(res.length, 2, "I got two records");
    equal(res[1].key, 'cdefg', "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

module("isin");
  test("Find records with a value in a list based on KV convention", function(){
    var 
      db = DB(
        { key: 0 }, 
        { key: 1 }, 
        { key: 2 }
      ),
      res = db.find({key: db.isin([0,2])});

    equal(res.length, 2, "I got two records");
    equal(res[1].key, 2, "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find records with a value in a list based on KV convention using the short syntax", function(){
    var 
      db = DB(
        { key: 0 }, 
        { key: 1 }, 
        { key: 2 }
      ),
      res = db.find({key: [0,2]});

    equal(res.length, 2, "I got two records");
    equal(res[1].key, 2, "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find records with a value in a list based on a function-callback + array convention", function(){
    var 
      db = DB(
        { key: 'apple' }, 
        { key: 'bananas' },
        { key: 'red apple' },
        { key: 'apple pie' },
        { key: 'blueberries' }
      ),
      res = db.find({key: [db.like('apple')]});

    equal(res.length, 3, "I got three records");
  });

  test("Find records with a value in a list based on a mixed-use + array convention", function(){
    var 
      db = DB(
        { key: 'apple' }, 
        { key: 'bananas' },
        { key: 'red apple' },
        { key: 'apple pie' },
        { key: 'blueberries' }
      ),
      res = db.find({key: [db.like('apple pie'), 'apple']});

    equal(res.length, 2, "I got two records");
  });

  test("Find records with a value in a list based on a multi-functional + array convention", function(){
    var 
      db = DB(
        { key: 'apple' }, 
        { key: 'bananas' },
        { key: 'red apple' },
        { key: 'apple pie' },
        { key: 'blueberries' }
      ),
      res = db.find({key: [db.like('apple pie'), db.like('red apple')]});

    equal(res.length, 2, "I got two records");
  });

  test("Find records with a value in a list based on argList convention", function(){
    var 
      db = DB(
        { key: 0 }, 
        { key: 1 }, 
        { key: 2 }
      ),
      res = db.find(db.isin('key', [0,2]));

    equal(res.length, 2, "I got two records");
    equal(res[1].key, 2, "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

module("missing");
  test("Find records without a single specific key set", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.find(db.missing('key2'));

    equal(res.length, 2, "I got two records");
    equal(res[0].key1, 0, "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });
  test("Find records without two specific keys set", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key1: false, key2: 'value2' }, 
        { key3: 'value3' }
      ),
      res = db.find(db.missing('key1', 'key2'));

    equal(res.length, 1, "I got one record");
    equal(res[0].key3, 'value3', "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });
  test("Chaining", function(){
    var 
      db = DB(
        { key1: 0, key3: 42 }, 
        { key1: 0, key2: 0 }, 
        { key1: 'value3' }
      ),
      res = db.find(
        {key1: 0} // Should yield the first two entries
      ).missing('key2'); // should narrow it down to only the first

    equal(res.length, 1, "I got one record");
    equal(res[0].key3, 42, "It is the right one");
  });
  test("Find records comma'd with a filter", function(){
    var 
      db = DB(
        { key1: 0, key3: 42 }, 
        { key1: 0, key2: 0 }, 
        { key1: 'value3' }
      ),
      res = db.find(
        {key1: 0}, // Should yield the first two entries
        db.missing('key2') // should narrow it down to only the first
      );

    equal(res.length, 1, "I got one record");
    equal(res[0].key3, 42, "It is the right one");
  });


module('hasKey');
  test("Find records with a single specific key set", function(){
    var 
      db = DB(
        { key1: 0 },
        { key2: 'value2' },
        { key1: 'value3' }
      ),
      res = db.hasKey('key2');

    equal(res.length, 1, "I got one record");
    equal(res[0].key2, 'value2', "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find records with a single specific key set (chained)", function(){
    var 
      db = DB(
        { key1: 0 },
        { key2: 'value2' },
        { key1: 0 }
      ),
      res = db.find({key1: 0}).hasKey('key2');

    equal(res.length, 0, "I got zero records");
  });

  test("Find records with a single specific key set (chained partial)", function(){
    var 
      db = DB(
        { key1: 0,
          key2: 'here'
        },
        { key2: 'value2' },
        { key1: 0 }
      ),
      res = db.find({key1: 0}).hasKey('key2');

    equal(res.length, 1, "I got one records");
    equal(res[0].key2, 'here', "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

module('has');
  test("Search amongst an array", function(){
    var
      db = DB(
        {a: [1, 2, 3]},
        {a: [2, 3, 4]},
        {b: [0, 1, 2]}
      ),
      res = db.find({a: db.has(1)});

    equal(res.length, 1, "I got one record");
    equal(res[0].a[0], 1, "It's the right one");
  });

module('select');
  test("Select records by a single key", function(){
    expect(3);
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.select('key1');

    equal(res.length, 2, "I got two records");
    equal(res[0], 0, "It is the right one");
    equal(res[1], 'value3', "It is the right one");
  });

  test("Select records by two keys", function(){
    expect(3);
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.select(['key1', 'key2']);

    // The result should be something like:
    // [0, undefined], [undefined, value2], [value3, undefined]
    equal(res.length, 3, "I got three record");
    equal(res[0][0], 0, "It is the right one");
    equal(res[1][1], 'value2', "It is the right one");
  });

  test("Select records by a key that is not present", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.select(['key3', 'key4']);

    // The result should be something like:
    // [0, undefined], [undefined, value2], [value3, undefined]
    equal(res.length, 0, "I got zero record");
  });

module('slice');
  test("Slice the first 4 records", function(){
    expect(2);
    var 
      db = DB([1, 2, 3, 4, 5, 6, 7, 8, 9, 10]),
      res = db.slice(0, 4);

    equal(res.length, 4, "I got four records");
    equal(db.find().length, 10, "I have 10 total records");
  });
  test("Slice the first 4 records - method 2", function(){
    expect(2);
    var 
      db = DB([1, 2, 3, 4, 5, 6, 7, 8, 9, 10]),
      res = db.find().slice(0, 4);

    equal(res.length, 4, "I got four records");
    equal(db.find().length, 10, "I have 10 total records");
  });
  test("Slice the first 4 records - method 3", function(){
    expect(2);
    var 
      db = DB([1, 2, 3, 4, 5, 6, 7, 8, 9, 10]),
      res = db.find().select('*').slice(0, 4);

    equal(res.length, 4, "I got four records");
    equal(db.find().length, 10, "I have 10 total records");
  });

module('invert');
  test("Find one element by Object, invert results", function(){
    var 
      db = DB(
        { key1: 0 }, 
        { key2: 'value2' }, 
        { key1: 'value3' }
      ),
      res = db.find({key1: 0}).invert();

    equal(res.length, 2, "I got two records");
    equal(res[0].key2, 'value2', "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find two elements by Object, invert results", function(){
    var 
      db = DB(
        { key1: 0, a: 1 }, 
        { key2: 'value2' }, 
        { key1: 'value3', a: 1 }
      ),
      res = db.find({a: 1}).invert();

    equal(res.length, 1, "I got one record");
    equal(res[0].key2, 'value2', "It is the right one");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

  test("Find all elements anonymously, invert results", function(){
    var 
      db = DB(
        { key1: 0, a: 1 }, 
        { key2: 'value2' }, 
        { key1: 'value3', a: 1 }
      ),
      res = db.find().invert();

    equal(res.length, 0, "I got zero records");
    equal(typeof res.find, 'function', "It looks to be chained");
  });

module('sync');
  test("Insert an element", function(){
    var 
      db = DB(),
      data,
      ran = false;
      
    db.sync(function(raw) {
      ran = true;
      data = raw;
    });

    db.insert({key: 'value'});

    equal(ran, true, 'Synchronization function ran');
    equal(data.length, 1, 'One item returned');
  });
  test("Remove an element", function(){
    var 
      db = DB({key: 0}, {key: 1}),
      data,
      ran = false;
      
    db.sync(function(raw) {
      ran = true;
      data = raw;
    });

    db.find({key: 0}).remove();

    equal(ran, true, 'Synchronization function ran');
    equal(data.length, 1, 'One item returned');
  });
  test("Update an element", function(){
    var 
      db = DB({key: 0}),
      data,
      ran = false;
      
    db.sync(function(raw) {
      ran = true;
      data = raw;
    });

    db.find({key: 0}).update({key: 1});

    equal(ran, true, 'Synchronization function ran');
    equal(data.length, 1, 'One item returned');
  });
  test("Insert an element x 4", function(){
    var 
      db = DB(),
      data,
      ran = 0;
      
    db.sync(function(raw) {
      ran++;
      data = raw;
    });

    for(var i = 0; i < 4; i++) {
      db.insert({key: 'value'});
    }

    equal(ran, 4, 'Synchronization function ran');
    equal(data.length, 4, 'One item returned');
  });

  test("Insert an element x 4 functions", function(){
    var 
      db = DB(),
      data,
      ran = 0;
      
    for(var i = 0; i < 4; i++) {
      db.sync(function(raw) {
        ran++;
        data = raw;
      });
    }

    for(var i = 0; i < 4; i++) {
      db.insert({key: 'value'});
    }

    equal(ran, 16, 'Synchronization function ran');
    equal(data.length, 4, 'One item returned');
  });
module('view');
  test("Create a view", function(){
    var 
      db = DB({ 
          index: 0,
          key: "one"
        }, 
        { 
          index: 'value2',
          key: "valuetwo" 
        }, 
        { 
          index: 'value3',
          key: "valuethree" 
        }),

      view = db.view('index');

    equal(view.value2.key, 'valuetwo', 'view k/v seems to be ok');
  });

  test("Create a deep view", function(){
    var 
      db = DB({ 
        index: {a: [0]},
          key: "one"
        }, 
        { 
          index: {a: ['value2']},
          key: "valuetwo" 
        }, 
        { 
          index: {a: ['value3']},
          key: "valuethree" 
        }),

      view = db.view('index.a[0]');

    equal(view.value2.key, 'valuetwo', 'view k/v seems to be ok');
    equal(view[0].key, 'one', 'view k/v seems to be ok');
    
  });

  test("Update a view", function(){
    var 
      db = DB({ 
          index: 0,
          key: "one"
        }, 
        { 
          index: 'value2',
          key: "valuetwo" 
        }, 
        { 
          index: 'value3',
          key: "valuethree" 
        }),

      view = db.view('index');

    db.find({index: 'value2'}).update({index: 'value4'});

    equal(view.value2, undefined, 'Old index was deleted');
    equal(view.value4.key, 'valuetwo', 'new index was created');
  });

module('lazyView');
  test("Chained lazyView", function(){
    var 
      view = DB({ 
          index: 0,
          key: "one"
        }, 
        { 
          index: 'value2',
          key: "valuetwo" 
        }, 
        { 
          index: 'value3',
          key: "valuethree" 
        }).lazyView('index');

    equal(view.value2.key, 'valuetwo', 'view k/v seems to be ok');
  });
  test("Create a lazyView", function(){
    var 
      db = DB({ 
          index: 0,
          key: "one"
        }, 
        { 
          index: 'value2',
          key: "valuetwo" 
        }, 
        { 
          index: 'value3',
          key: "valuethree" 
        }),

      view = db.lazyView('index');

    equal(view.value2.key, 'valuetwo', 'view k/v seems to be ok');
  });
  test("Update a lazyView", function(){
    var 
      db = DB({ 
          index: 0,
          key: "one"
        }, 
        { 
          index: 'value2',
          key: "valuetwo" 
        }, 
        { 
          index: 'value3',
          key: "valuethree" 
        }),

      view = db.lazyView('index');

    db.find({index: 'value2'}).update({index: 'value4'});

    equal(view.value2.key, 'valuetwo', 'No synchronization was run so view is out of date');
    view();

    equal(view.value2, undefined, 'Old index was deleted');
    equal(view.value4.key, 'valuetwo', 'new index was created');
  });

module("indexBy");
  test("re-ordering", function(){
    var db = DB([
      {key: 5},
      {key: 3},
      {key: 7},
      {key: 2}
    ]);

    equal(db.__raw__.length, 4, "The database has 4 elements");
    equal(db.__raw__[0].key, 5, "The first element is 5");
    equal(db.__raw__[1].key, 3, "The second element is 3");

    db.indexBy('key', 'asc');
    equal(db.__raw__.length, 4, "The database still has 4 elements");
    equal(db.__raw__[0].key, 2, "The first element is 2");
    equal(db.__raw__[1].key, 3, "The second element is 3");
    equal(db.__raw__[2].key, 5, "The third element is 5");
    equal(db.__raw__[3].key, 7, "The fourth element is 7");

    db.indexBy('key', 'desc');
    equal(db.__raw__.length, 4, "The database still has 4 elements");
    equal(db.__raw__[0].key, 7, "The first element is 7");
    equal(db.__raw__[1].key, 5, "The second element is 5");
    equal(db.__raw__[2].key, 3, "The third element is 3");
    equal(db.__raw__[3].key, 2, "The fourth element is 2");
  });
module('each');
  test("Select 4 pairs from a database, run a test on each of them", function(){
    expect(4);
    var db = DB([
      {key: 5},
      {key: 3},
      {key: 7},
      {key: 2}
    ]);

    db.find().each(function(what) {
      equal(!([5,3,7,2].indexOf(what.key) + 1), false, "The function is run");
    });
  });

  test("Select 4 pairs from a database, run a console.log each of them", function(){
    var db = DB([
      {key: 5},
      {key: 3},
      {key: 7},
      {key: 2}
    ]);

    var my = {
      func: function(m) {
        console.log(arguments);
      }
    };
    db.each([my,my.func]);
  });

  test("Select 4 values from a database, make sure that it's a one dimensional array", function(){
    expect(4);
    var db = DB([
      {key: 5},
      {key: 3},
      {key: 7},
      {key: 2}
    ]);

    db.find().select('key').each(function(what) {
      equal(!([5,3,7,2].indexOf(what) + 1), false, "The function is run");
    });
  });

  test("Select 4 values from a database, make sure return values get propogated", function(){
    var db = DB([
      {key: false},
      {longkey: 3},
      {key: 7},
      {key: 2}
    ]);

    var res = db.find().select('key').each(function(what) {
      return what;
    });

    equal(res.join(','), 'false,7,2', "The right data came back");
  });

module('order');

  test("Sorting by a numeric key", function(){
    var db = DB(),
      list = [],
      newplace,
      ix = 0;

    // Create an in-order list of 100 items numbered
    // sequentially
    for(ix = 0; ix < 100; ix++) {
      list[ix] = ix;
    }

    // Do inplace fisher-yates of the entire set
    for(ix = 99; ix > 0; ix--) {
      newplace = Math.floor(Math.random() * (ix - 1));
      swap = list[newplace];
      list[newplace] = list[ix];
      list[ix] = swap;
    }

    // Now we have a 100 member array of
    // out of order unique keys
    for(ix = 0; ix < 100; ix++) {
      db.insert({key : list[ix]});
    }

    // Try to sort the new db by the key, ascending
    var validate = db.find().sort('key', 'asc');

    // we start at 1 for a relative comparator
    for(ix = 1; ix < validate.length; ix++) {
      // Assert that each index is one more then the previous
      equal(validate[ix].key - validate[ix - 1].key, 1, "in-order successful")
    }

  });

  test("Sorting by a numeric key (2)", function(){
    var 
      db = DB(),
      // have some post-insertion records
      ins =[
        {b:2},
        {b:2},
        {b:2}
      ],
      start = 2;

    // drop some ordinal records in
    db.insert(
      {id:1,a:1},
      {id:2,a:1},
      {id:3,a:1},
      {id:4,a:1}
    );

    // increment the existing entries by ins.length which
    // are past $start
    db 
      .find({id: db('> ' + start)})
      .update(function(e){ e.id += ins.length });

    // insert our post records and give it the gap
    db.insert(ins).update(function(e) { 
      start++;
      e.id = start;
    });

    // Try to sort the new db by the key, ascending
    var validate = db.find().sort('id', 'asc');

    // we start at 1 for a relative comparator
    for(ix = 1; ix < validate.length; ix++) {
      // Assert that each index is one more then the previous
      equal(validate[ix].id - validate[ix - 1].id, 1, "in-order successful")
    }
  });

module('schema');
  test('Getting a schema with 20 records', function(){
    var 
      db = DB(), 
      ix, 
      iy,
      schema,
      max = 20, 
      row = [];

    for(ix = 0; ix < max; ix++) {
      row = {};
      for(iy = 0; iy < 5; iy++) {
        row['f' + iy] = ix + iy;
      }
      db.insert(row);
    }
    schema = db.schema().sort().join('');
    equal(schema, 'f0f1f2f3f4' , "schema is right!");
  });
  test('Getting a schema with 4 records', function(){
    var 
      db = DB(), 
      ix, 
      iy,
      schema,
      max = 4, 
      row = [];

    for(ix = 0; ix < max; ix++) {
      row = {};
      for(iy = 0; iy < 5; iy++) {
        row['f' + iy] = ix + iy;
      }
      db.insert(row);
    }
    schema = db.schema().sort().join('');
    equal(schema, 'f0f1f2f3f4' , "schema is right!");
  });
  test('Getting a schema with 1 record', function(){
    var 
      db = DB([{key1: 'value', key2: 'value'}]), 
      schema;

    schema = db.schema().sort().join('');
    equal(schema, 'key1key2' , "schema is right!");
  });

module('group');
  test("Grouping by department (from the readme)", function(){
    expect(3);

    var db = DB(
      { department: "accounting", name: "Alice" },
      { department: "accounting", name: "Bob" },
      { department: "IT", name: "Eve" }
    );

    var toTest = db.find().group('department');

    equal(Object.keys(toTest).sort().join(' '), 'IT accounting', "Keys are right");
    equal(toTest.accounting.length, 2, "Accounting length is right");
    equal(toTest.IT.length, 1, "IT length is right");
  });
  test("Grouping by number", function(){
    expect(2);

    var db = DB(
      { department: 1, name: "Alice" },
      { department: 1, name: "Bob" }
    );

    var toTest = db.group('department');

    equal(Object.keys(toTest).sort().join(' '), '1', "Keys are right");
    equal(toTest[1].length, 2, "Accounting length is right");
  });
});
</script>


