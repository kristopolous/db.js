var module=module||{},DB=module.exports=function(){"use strict";function escapeRegExp(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function extend(r){return each(slice.call(arguments,1),function(n){if(n)for(var e in n)r[e]=n[e]}),r}function kvarg(r){var n={};return 2===r.length?(n[r[0]]=r[1],n):1===r.length?r[0]:void 0}function hash(r){var n={};return each(r,function(r){n[r]=!0}),n}function trace(r,n){if(!r||_.isBool(r))return trace.active=0===arguments.length?!trace.active:r,n&&(trace.cb=n),trace.active;if(!r.__trace__){r.__trace__={};var e=0;each(r,function(t,i){_.isFun(i)&&(r.__trace__[t]=i,r[t]=function(){e++;var i=slice.call(arguments),a=[t].concat(i);n?n({"this":this,args:i,func:t,level:e}):(trace.l%=500,console.log(trace.l,a),trace[trace.l++]=a);var c=r.__trace__[t].apply(this,i);return e--,c})})}}function copy(r){return"length"in r?slice.call(r):values(r)}function setdiff(r,n){var e=[];stain(n);for(var t=0,i=r.length;i>t;t++)isStained(r[t])?unstain(r[t]):e.push(r[t]);return e}function stain(r){_stainID++,each(r,function(r){r[_stainKey]=_stainID})}function unstain(r){delete r[_stainKey]}function isStained(r){return r[_stainKey]===_stainID}function has(r,n){var e,t=arguments.length,i=1===t?r:n,a={};if(_.isArr(i)){var t=i.length;e=function(r){for(var n=0;t>n;n++)if(indexOf(r,i[n])>-1)return!0;return!1}}else e=function(r){return indexOf(r,i)>-1};return 2===t?(a={},a[r]=e,a):e}function val_comprehension(r){if(_.isObj(r)){var n=keys(r)[0],e=n.slice(1);try{r=DB[e](r[n])}catch(t){throw new Error(e+" is an unknown function")}}else _.isArr(r)&&(r=isin(r));return r}function find(){var r,n,e,t,i,a,c=slice.call(arguments),s=_.isArr(this)?this:c.shift();for(2===c.length&&_.isStr(c[0])&&(i={},i[c[0]]=c[1],c=[i]),e=0;e<c.length;e++)if(n=c[e],_.isArr(n)){if(_.isScalar(n[0])&&2===c.length){var u=val_comprehension(c.pop());t=[function(r){for(var e=0;e<n.length;e++)if(equal(r[n[e]],u))return!0}]}else t=map(n,expression());r=t.length,s=_filter.call(s,function(n){for(var e=!0,i=0;r>i;i++){if(t[i](n))return!0;e=!1}return e})}else _.isFun(n)?s=_filter.call(s,n):each(n,function(r,n){n=val_comprehension(n),t=_.isFun(n)?function(e){return r in e?(a=e[r],_.isFun(a)&&(a=a()),n(a,e)):void 0}:function(e){return a=e[r],_.isFun(a)&&(a=a()),r in e&&a===n},s=_filter.call(s,t)});return s}function missing(r){var n=hash(r);return function(r){for(var e in n)if(e in r)return!1;return!0}}function equal(r,n){return r===n||_.isFun(n)&&n(r)||!_.isUndef(r)&&r.join&&n.join&&r.sort().toString()===n.sort().toString()||JSON.stringify(r)===JSON.stringify(n)}function isArray(r){var n=r.sort().join("");return function(r){return r.sort().join("")===n}}function like(r,n){var e,t,i,a=arguments.length,c={};return 1===a?t=r:2===a&&(t=n),t=t.toString(),e=function(r){if(null===r)return!1;try{i=new RegExp(t,"img")}catch(n){i=new RegExp(escapeRegExp(t),"img")}return r.toString().search(i)>-1},2===a?(c={},c[r]=e,c):e}function update(r,n){var e,t=this;return n!==_u&&(e=r,r={},r[e]=n),_.isFun(r)?each(t,r):each(r,function(r,n){_.isFun(n)?each(t,function(e){_.isFun(e[r])?e[r](n(e)):e[r]=n(e)}):each(t,function(e){_.isFun(e[r])?e[r](n):e[r]=n})}),this}function not(r){return function(){return!r.apply(this,arguments)}}function ewrap(arg,str){var key=str+":"+arg;if(!(key in _eCache))try{_eCache[key]=eval("(function("+arg+"){"+str+"})")}catch(ex){_eCache[key]=!1}return _eCache[key]}function fwrap(r,n){var e=n+":"+r;if(!(e in _fCache))try{_fCache[e]=new Function(r,"try{return "+n+"}catch(e){}")}catch(t){_fCache[e]=!1}return _fCache[e]}function eachRun(r,n){var e,t=0,i=[];if(2===arguments.length?(e=r,r=n):e=_.isArr(this)?this:this.find(),_.isArr(r)&&2===r.length&&(t=r[0],r=r[1]),_.isArr(e))i=mapSoft(e,r);else{i={};for(var a in e)_.isFun(e[a])||(i[a]=r.call(t,e[a]))}return i}function DB(arg0,arg1){function sync(){syncLock||(syncLock=!0,each(syncList,function(r){r.call(ret,raw)}),syncLock=!1)}function chain(r){for(var n in chainList)r[n]=ret[n];return r.last=r[r.length-1],r}function list2data(r){for(var n=[],e=0,t=r.length;t>e;e++)n[e]=raw[r[e]];return n}var constraints={addIf:[]},constrainCache={},syncList=[],syncLock=!1,_ix={ins:0,del:0},_template=!1,ret=expression(),_g={},raw=[];if(extend(ret,{slice:function(){var r=_.isArr(this)?this:ret.find();return chain(slice.apply(r,arguments))},transaction:{start:function(){syncLock=!0},end:function(){syncLock=!1,sync()}},schema:function(){for(var r,n={},e=_.isArr(this)?this:ret.find(),t=e.length,i=Math.ceil(Math.min(10,t/3)),a=0;t>a;a+=i){r=e[a];for(var c in r)n[c]=_u}return keys(n)},constrain:function(){extend(constraints,kvarg(arguments))},addIf:function(r){return r&&constraints.addIf.push(r),constraints.addIf},beforeAdd:function(r){return ret.addIf(r?function(){return r.apply(0,arguments),!0}:!1)},unset:function r(n){if(_.isArr(n))return each(n,r);var e=_.isArr(this)?this:ret.find();return each(e,function(r){n in r&&delete r[n]}),sync(),chain(e)},each:eachRun,isFunction:_.isFun,isString:_.isStr,map:eachRun,not:not,findFirst:function(){var r,n=_filter,e=!1;_filter=_filterThrow;try{r=ret.find.apply(this,arguments)}catch(t){r=t,e=!0}return _filter=n,e?r:r.length?r[0]:!1},has:has,hasKey:function(){var r=_.isArr(this)?this:this.find(),n=r.find(missing(slice.call(arguments)));return this.invert(n,r)},isin:isin,like:like,invert:function(r,n){return chain(setdiff(n||raw,r||this))},missing:function(){var r=missing(slice.call(arguments));return _.isArr(this)?this.find(r):r},sync:function(r){return r?syncList.push(r):sync(),ret},template:function(r){return _template=r,ret},update:function(){var r=update.apply(_.isArr(this)?this:ret.find(),arguments);return sync(),chain(r)}}),extend(ret.template,{create:ret.template,update:function(r){return extend(_template||{},r),ret},get:function(){return _template},destroy:function(){return _template=!1,ret}}),ret.first=ret.findFirst,ret.group=function(){var r=slice.call(arguments||[]),n=r.shift(),e={},t=_.isArr(this)?this:ret.find();return each(t,function(r){var t=n in r?r[n]:[_u];each(t,function(n){n in e||(e[n]=chain([])),e[n].push(r)})}),r.length&&each(e,function(n,t){e[n]=ret.group.apply(t,r)}),e},ret.keyBy=function(){var r=ret.group.apply(this,arguments);return each(r,function(n,e){r[n]=e[0]}),r},ret.distinct=function(r){return keys(ret.keyBy(r))},ret.indexBy=function(){var r=chain;chain=function(r){return r},ret.__raw__=raw=ret.order.apply(this,arguments),chain=r},ret.order=ret.sort=ret.orderBy=function(arg0,arg1){var key,fnSort,len=arguments.length,order,filter=_.isArr(this)?this:ret.find();return _.isFun(arg0)?fnSort=arg0:_.isStr(arg0)&&(key=arg0,1===len?order="x-y":2===len&&(order=_.isStr(arg1)?{asc:"x-y",desc:"y-x"}[arg1.toLowerCase()]:arg1),_.isStr(order)&&(order=_orderCache[order]?_orderCache[order]:_orderCache[order]=new Function("x,y","return "+order)),eval("fnSort=function(a,b){return order(a."+key+", b."+key+")}")),chain(slice.call(filter).sort(fnSort))},ret.where=ret.find=function(){var r=slice.call(arguments||[]);return _.isArr(this)||(r=[raw].concat(r)),chain(find.apply(this,r))},ret.lazyView=function(field,type){var myix={del:_ix.del,ins:_ix.ins},res={},keyer;return-1===field.search(/[()]/)?("["===field.charAt(0)&&"."===field.charAt(0)||(field="."+field),eval("keyer=function(r,ref){try{ref[rX]=res[rX]=r;}catch(x){}}".replace(/X/g,field))):eval("keyer=function(r,ref){var val=r.X;try{ref[val]=res[val]=r;}catch(x){}}".replace(/X/g,field)),Object.defineProperty(res,"update",{enumerable:!1,configurable:!1,writable:!1,value:function(r){if(r){if("del"===r&&myix.del===_ix.del)return;if("ins"===r&&myix.ins===_ix.ins)return}myix={del:_ix.del,ins:_ix.ins};var n={};each(raw,function(r){keyer(r,n)});for(var e in res)e in n||"update"==e||delete res[e];Object.defineProperty(res,"length",{enumerable:!1,configurable:!1,writable:!0,value:Object.keys(res).length})}}),res.update(),res},ret.view=function(r,n){var e=ret.lazyView(r,n);return ret.sync(e.update),e},ret.select=function(r){var n,e=_.isArr(this)?this:ret.find(),t={};return arguments.length>1?r=slice.call(arguments):_.isStr(r)&&(r=[r]),n=r.length,each(r,function(r,i){if("*"===r)t=map(e,values);else for(var a=0,c=e.length;c>a;a++){var s=e[a];r in s&&(n>1?(t[a]||(t[a]=[]),t[a][i]=s[r]):t[a]=s[r])}}),chain(values(t))},ret.insert=function(r){var n,e=constraints.unique,t=[],i=[],a=[];return i=arguments.length>1?slice.call(arguments):_.isArr(r)?r:[r],each(i,function(r){var i=!0;if(e&&e in r){var c,s="c-"+e;_g[s]?_g[s].update("del"):_g[s]=ret.lazyView(e),c=_g[s],r[e]in c?(t.push(c[r[e]]),a.push(c[r[e]]),i=!1):c[r[e]]=r}if(each(constraints.addIf,function(n){i&=n(r)}),i){if(_ix.ins++,n=raw.length,_template){var u={};each(_template,function(r,n){_.isFun(n)?u[r]=n():u[r]=n}),r=extend(u,r)}raw.push(r),a.push(n)}}),sync(),extend(chain(list2data(a)),{existing:t})},ret.flash=function(r){ret.__raw__=raw=raw.concat(r)},ret.trace=function(r){DB.trace(ret,r)},ret.remove=function(r){var n,e,t,i=!1,a=[];if(_.isArr(this))t=this;else if(_.isArr(r))t=r;else{if(arguments.length>0)return a=ret.find.apply(this,arguments),a.length&&(ret.__raw__=raw=ret.invert(a),_ix.del++,sync()),chain(a.reverse());t=ret.find()}stain(t);for(var c=raw.length-1,n=raw.length;c>=0;c--)isStained(raw[c])?(unstain(raw[c]),a.push(raw[c])):(n-(c+1)&&(e=c+1,raw.splice(e,n-e),i=!0),n=c);return e=c+1,n-e&&(raw.splice(e,n-e),i=!0),i&&(_ix.del++,sync()),chain(a.reverse())},1===arguments.length)if(_.isArr(arg0))ret.insert(arg0);else if(_.isFun(arg0))ret.insert(arg0());else{if(_.isStr(arg0))return ret.apply(this,arguments);if(_.isObj(arg0)){var fails=!1;each(arg0,function(r,n){ret[r]||(fails=!0),fails||ret[r](n)}),fails&&ret.insert(arg0)}}else arguments.length>1&&ret.insert(slice.call(arguments));return ret.__raw__=raw,trace.active&&ret.trace(trace.cb),ret}var _u,slice=Array.prototype.slice,toString=Object.prototype.toString,_orderCache={},_compProto={},_stainID=0,_stainKey="_4ab92bf03191c585f182",_={isFun:function(r){return!!(r&&r.constructor&&r.call&&r.apply)},isStr:function(r){return!!(""===r||r&&r.charCodeAt&&r.substr)},isNum:function(r){return"[object Number]"===toString.call(r)},isUndef:function(r){return isNaN(r)||null===r||r===_u},isScalar:function(r){return _.isStr(r)||_.isNum(r)||_.isBool(r)},isArr:[].isArray||function(r){return"[object Array]"===toString.call(r)},isBool:function(r){return r===!0||r===!1||"[object Boolean]"===toString.call(r)},isObj:function(r){return _.isFun(r)||_.isStr(r)||_.isNum(r)||_.isArr(r)?!1:null==r?"object"===String(r):"[object Object]"===toString.call(r)||!0}},proxy=function(r,n){return function(){n.apply(r,slice.call(arguments))}},indexOf=[].indexOf?function(r,n){return r.indexOf(n)}:function(r,n){for(var e=r.length-1;-1!==e&&n!==r[e];e--);return e},keys=Object.keys||function(r){var n=[];for(var e in r)n.push(e);return n},values=function(r){var n=[];for(var e in r)n.push(r[e]);return n},obj=function(r,n){var e={};return e[r]=n,e},mapSoft=function(r,n){for(var e=[],t=0,i=r.length;i>t;t++)e.push(n(r[t],t));return e},map=[].map?function(r,n){return r.map(n)}:mapSoft,_filterThrow=function(r){for(var n=this.length,e=0;n>e;e++)if(r(this[e]))throw this[e];return[]},_filter=function(r){for(var n=this.length,e=0,t=[],i=0;n>i;i++)r(this[i])||(e!==i&&t.splice.apply(t,[i,i].concat(this.slice(e,i))),e=i+1);return e!==i&&t.splice.apply(t,[i,i].concat(this.slice(e,i))),t},each=[].forEach?function(r,n){if(_.isArr(r)){if(0===r.length)return;r.forEach(n)}else if(_.isStr(r)||_.isNum(r)||_.isBool(r))n(r);else for(var e in r)n(e,r[e])}:function(r,n){if(0!==r.length)if(_.isArr(r))for(var e=0,t=r.length;t>e;e++)n(r[e],e);else for(var i in r)n(i,r[i])};each("< <= > >= == === != !==".split(" "),function(r){_compProto[r]=Function("rhs","return function(x){return x"+r+"rhs}")}),trace.l=0,trace.active=!1;var isin=function(){return function(r,n){var e,t=arguments.length,i=1===t?r:n||[],a=[],c=[],s={};if(!_.isArr(i))throw new TypeError("isin's argument is wrong. ",i);return i.length?(each(i,function(r){_.isFun(r)?a.push(r):c.push(r)}),e=function(r){for(var n=indexOf(c,r)>-1,e=0;e<a.length&&!n;e++)n=a[e](r);return n}):e=_.isFun(i)?function(r){return indexOf(i(),r)>-1}:i,2===t?(s={},s[r]=e,s):e}}(),_fCache={},_eCache={},expression=function(){return function(r,n){var e,t;if(_.isStr(r))return t=r,2===arguments.length&&_.isStr(n)?(t=n,e=fwrap("x,rec","x."+r+t),e[r]=fwrap("x,rec","x "+t)):(e=fwrap("x,rec","x "+t),e||(e=fwrap("rec",r))),e;if(_.isObj(r)){var i,a=[],c=[];for(var s in r)i=r[s],_.isScalar(i)?(_.isStr(i)&&(i='"'+i+'"'),a.push("rec['"+s+"']==="+i)):_.isArr(i)?c.push(isin(s,i)):a.push("equal(rec['"+s+"'],arg0['"+s+"'])");return a.length&&c.push(ewrap("rec,arg0","return "+a.join("&&"))),function(r,n){for(var e,t,i,a=0;a<c.length;a++)if(e=c[a],_.isObj(e)){if(t=keys(e)[0],i=e[t],_.isArr(i)){if(-1===indexOf(i,r[t]))return!1}else if(!i(r[t]))return!1}else if(!e(r,n))return!1;return!0}}}},chainList=hash(["distinct","each","find","findFirst","first","group","has","hasKey","indexBy","insert","invert","isin","keyBy","lazyView","like","missing","order","orderBy","remove","schema","select","slice","sort","unset","update","view","where"]);return extend(DB,{find:find,expr:expression(),diff:setdiff,each:eachRun,map:map,not:not,like:like,trace:trace,values:values,isin:isin,isArray:isArray,isString:_.isStr,isFunction:_.isFun,local:function(){return"(function(){ return "+DB.apply(this,arguments).toString()+";})()"},copy:function(r){return map(r,function(r){return extend({},r)})},objectify:function(r,n){var e=[];return each(n,function(n){var t={};each(r,function(r,e){t[r]=n[e]}),e.push(t)}),e},reduceLeft:function(r,n){1===arguments.length&&(n=r,r=0);var e=_.isStr(n)?new Function("y,x","return y "+n):n;return function(n,t){for(var i=r,a=0,c=n.length;c>a;a++)n[a]&&(i=e(i,n[a],t));return i}},reduceRight:function(r,n){return 1===arguments.length&&(n=r,r=0),n=DB.reduceLeft(r,n),function(r){return n(r.reverse())}}}),DB}();DB.version="0.0.2.79-20160518";
//# sourceMappingURL=db.map.js
